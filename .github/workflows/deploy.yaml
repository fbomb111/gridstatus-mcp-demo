name: Deploy GridStatus MCP Demo

on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'
      - 'LICENSE'
  workflow_dispatch:

concurrency:
  group: deploy-gridstatus
  cancel-in-progress: true

env:
  RESOURCE_GROUP: rg-gridstatus-demo
  ACR: prgptacr
  AZURE_MSI_CLIENT_ID: a778803b-b814-42dd-8c82-e2778c9d98c4

jobs:
  deploy-api:
    runs-on: [self-hosted, Linux, X64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure + ACR Login
        run: |
          az login --identity --client-id ${{ env.AZURE_MSI_CLIENT_ID }}
          az acr login --name ${{ env.ACR }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Compute build metadata
        run: |
          echo "IMAGE_TAG=${GITHUB_SHA:0:7}" >> $GITHUB_ENV

      - name: Capture current image (for rollback)
        run: |
          CURRENT=$(az containerapp show \
            --name ca-gridstatus-api \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "properties.template.containers[0].image" -o tsv)
          echo "ROLLBACK_IMAGE=$CURRENT" >> $GITHUB_ENV

      - name: Build and Push API image
        run: |
          docker buildx build \
            --file backend/Dockerfile \
            --build-arg GIT_SHA=${{ env.IMAGE_TAG }} \
            --tag ${{ env.ACR }}.azurecr.io/gridstatus-api:${{ env.IMAGE_TAG }} \
            --tag ${{ env.ACR }}.azurecr.io/gridstatus-api:latest \
            --push \
            backend/

      - name: Deploy API to Container App
        run: |
          az containerapp update \
            --name ca-gridstatus-api \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR }}.azurecr.io/gridstatus-api:${{ env.IMAGE_TAG }}

      - name: Wait for API ready
        run: |
          FQDN=$(az containerapp show \
            --name ca-gridstatus-api \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "properties.configuration.ingress.fqdn" -o tsv)
          READY_URL="https://${FQDN}/ready"
          echo "Waiting for $READY_URL..."

          for i in {1..30}; do
            if curl -sf "$READY_URL" > /dev/null 2>&1; then
              echo "API is ready!"
              curl -s "https://${FQDN}/ready" | python3 -m json.tool
              exit 0
            fi
            echo "Attempt $i/30 - waiting 10s..."
            sleep 10
          done

          echo "API did not become ready in time"
          exit 1

      - name: Rollback API on failure
        if: failure()
        run: |
          echo "Rolling back to ${{ env.ROLLBACK_IMAGE }}"
          az containerapp update \
            --name ca-gridstatus-api \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ROLLBACK_IMAGE }}

  deploy-mcp:
    runs-on: [self-hosted, Linux, X64]
    needs: deploy-api
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure + ACR Login
        run: |
          az login --identity --client-id ${{ env.AZURE_MSI_CLIENT_ID }}
          az acr login --name ${{ env.ACR }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Compute build metadata
        run: |
          echo "IMAGE_TAG=${GITHUB_SHA:0:7}" >> $GITHUB_ENV

      - name: Capture current image (for rollback)
        run: |
          CURRENT=$(az containerapp show \
            --name ca-gridstatus-mcp \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "properties.template.containers[0].image" -o tsv)
          echo "ROLLBACK_IMAGE=$CURRENT" >> $GITHUB_ENV

      - name: Build and Push MCP image
        run: |
          docker buildx build \
            --file mcp-server/Dockerfile \
            --build-arg GIT_SHA=${{ env.IMAGE_TAG }} \
            --tag ${{ env.ACR }}.azurecr.io/gridstatus-mcp:${{ env.IMAGE_TAG }} \
            --tag ${{ env.ACR }}.azurecr.io/gridstatus-mcp:latest \
            --push \
            mcp-server/

      - name: Deploy MCP to Container App
        run: |
          az containerapp update \
            --name ca-gridstatus-mcp \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR }}.azurecr.io/gridstatus-mcp:${{ env.IMAGE_TAG }}

      - name: Wait for MCP health
        run: |
          FQDN=$(az containerapp show \
            --name ca-gridstatus-mcp \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "properties.configuration.ingress.fqdn" -o tsv)
          HEALTH_URL="https://${FQDN}/health"
          echo "Waiting for $HEALTH_URL..."

          for i in {1..30}; do
            if curl -sf "$HEALTH_URL" > /dev/null 2>&1; then
              echo "MCP server is healthy!"
              curl -s "https://${FQDN}/health" | python3 -m json.tool
              curl -s "https://${FQDN}/.well-known/oauth-protected-resource" | python3 -m json.tool
              exit 0
            fi
            echo "Attempt $i/30 - waiting 10s..."
            sleep 10
          done

          echo "MCP server did not become healthy in time"
          exit 1

      - name: Rollback MCP on failure
        if: failure()
        run: |
          echo "Rolling back to ${{ env.ROLLBACK_IMAGE }}"
          az containerapp update \
            --name ca-gridstatus-mcp \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ROLLBACK_IMAGE }}

  release-mcpb:
    runs-on: [self-hosted, Linux, X64]
    needs: deploy-mcp
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Read version from package.json
        run: |
          VERSION=$(node -p "require('./mcp-server/package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "TAG=v$VERSION" >> $GITHUB_ENV

      - name: Build .mcpb extension
        run: bash mcp-server/scripts/build-mcpb.sh

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: GridStatus MCP v${{ env.VERSION }}
          body: |
            ## Install

            1. Download `gridstatus.mcpb` below
            2. Double-click to install in Claude Desktop
            3. Optional: add a [gridstatus.io](https://www.gridstatus.io) API key when prompted to unlock historical data

            Select **GridStatus Tutorial** from the + menu to get started.
          files: mcp-server/gridstatus.mcpb
          generate_release_notes: true
          make_latest: true
